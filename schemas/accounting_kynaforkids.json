[{
  "table_name": "Recruitment_Database",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Recruitment_Database`\n(\n  Date INT64,\n  Month INT64,\n  Year INT64,\n  Recruit_code STRING,\n  Dept STRING,\n  Position STRING,\n  Sources STRING,\n  Type_of_source STRING,\n  Name STRING,\n  Phone STRING,\n  Email STRING,\n  DOB DATE,\n  Experience_year STRING,\n  Link_CV STRING,\n  PIC STRING,\n  Status STRING,\n  Reason_of_failure STRING,\n  Notes STRING,\n  Interview_date INT64,\n  Interview_month INT64,\n  Interview_year INT64,\n  Interview_time STRING,\n  Interviewor STRING,\n  Onboard_date INT64,\n  Onboard_month INT64,\n  Onboard_year INT64,\n  Profile_code STRING,\n  Company_email STRING,\n  Employee_code STRING,\n  End_pro_date INT64,\n  End_pro_month INT64,\n  End_pro_year INT64,\n  Gross_salary INT64,\n  Salary_unit STRING,\n  Pro_salary_rate FLOAT64,\n  Resident_status_no_if_non_resident STRING,\n  Working_time STRING,\n  Link_offer STRING,\n  Link_prefill_form STRING,\n  CMND_id STRING,\n  CMND_date DATE,\n  CMND_place STRING,\n  Address STRING\n)\nOPTIONS(\n  sheet_range\u003d\"Database!A:AQ\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1I4Tp9XIQU9MbgFcc9IBkCyc8R8PRQpCDcXGeAMg6O50/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "doanhthuconlai1_1_chenhlechkhac_acc",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.doanhthuconlai1_1_chenhlechkhac_acc`\n(\n  Ngay_hach_toan DATE,\n  ma_hv STRING,\n  email STRING,\n  phone_number STRING,\n  program_name STRING,\n  country STRING,\n  chenh_lech_khac_NT FLOAT64,\n  chenh_lech_khac FLOAT64\n);"
}, {
  "table_name": "learning_retention_first_time",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.learning_retention_first_time`\nAS SELECT \r\n    bss.student_id as student_id, \r\n    EXTRACT(DATE from min(bs.begin_at)) as minDate ,\r\n    (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d bss.student_id)\r\n    as student_code\r\n  FROM `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n  left join `kynaforkids-server-production.kynaforkids.booking_session_student` bss on bs.id\u003dbss.booking_session_id \r\n  where (bs.status_id\u003d5 or (bs.status_id \u003d 7 and bs.cancel_config_id in (1,2,4,8))) and bs.program_id not in (3,8,13) and (select min(cast(bo.payment_content as INT64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo, `kynaforkids-server-production.kynaforkids.booking_session_student`bst where bst.booking_session_id \u003d bs.id   and bo.student_payment_id \u003d bst.student_payment_id) !\u003d 1\r\n  group by bss.student_id;"
}, {
  "table_name": "Acc_B2B_order_list",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_B2B_order_list`\n(\n  orderCode STRING,\n  cusName STRING,\n  address STRING,\n  taxCode STRING\n);"
}, {
  "table_name": "CB_employee_info_ref",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.CB_employee_info_ref`\n(\n  Employee_code STRING,\n  department STRING,\n  position STRING,\n  cv_name STRING,\n  employee_email STRING,\n  onboard_date DATE,\n  end_pro_date DATE,\n  candidate_email STRING,\n  dob DATE,\n  sex STRING,\n  current_address STRING,\n  marital_status STRING,\n  candidate_phone STRING,\n  relative_phone STRING,\n  profile_image STRING,\n  level STRING,\n  location STRING,\n  contract_type STRING,\n  employee_status STRING\n)\nOPTIONS(\n  sheet_range\u003d\"Sheet1!A:S\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1yb4n3P1L9Jdq1lGMeQGduF6BKGszDehALwUHluQMcao/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "doanhthuconlaiclass_chenhlechkhac_acc",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.doanhthuconlaiclass_chenhlechkhac_acc`\n(\n  Ngay_hach_toan DATE,\n  ma_hv STRING,\n  email STRING,\n  phone_number STRING,\n  program_name STRING,\n  country STRING,\n  chenh_lech_khac_NT FLOAT64,\n  chenh_lech_khac FLOAT64\n);"
}, {
  "table_name": "kyna_duo_math2_support",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.kyna_duo_math2_support`\n(\n  teacher_id INT64,\n  program STRING,\n  name STRING\n);"
}, {
  "table_name": "Recruitment_candidate_info",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Recruitment_candidate_info`\n(\n  submit_date TIMESTAMP,\n  profile_code STRING,\n  candidate_email STRING,\n  candidate_name STRING,\n  dob DATE,\n  sex STRING,\n  birth_place STRING,\n  hometown STRING,\n  nationality STRING,\n  religion STRING,\n  nation STRING,\n  resident_address STRING,\n  current_address STRING,\n  marriage_status STRING,\n  cmnd_id STRING,\n  cmnd_date DATE,\n  cmnd_place STRING,\n  individual_id STRING,\n  candidate_phone STRING,\n  relative_phone STRING,\n  education_level STRING,\n  school_name STRING,\n  bank_account STRING,\n  bank_name STRING,\n  bank_branch STRING,\n  personal_tax_code STRING,\n  social_insurance_code STRING,\n  registered_hospital STRING,\n  profile_image STRING,\n  cmnd_front_image STRING,\n  cmnd_back_image STRING,\n  candidate_cv STRING\n)\nOPTIONS(\n  sheet_range\u003d\"Form Responses 1!A:AG\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1o4K_r7hmbCbhxZN5jJCKSikkBwLn20aBnLeccXi04qc/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_invoice_tracking_total",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_invoice_tracking_total`\nAS SELECT * FROM `kynaforkids-server-production.accounting_kynaforkids.Acc_invoice_tracking_upload`\r\nUNION ALL\r\nSELECT * FROM `kynaforkids-server-production.accounting_kynaforkids.Acc_invoice_tracking_live`;"
}, {
  "table_name": "Acc_Doanhthuphanbo_booking_2022_10_01",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_Doanhthuphanbo_booking_2022_10_01`\nAS SELECT * FROM\r\n\r\n    (select \r\n      date(t1.booking_time) as begin_at,\r\n      t1.booking_id,\r\n      t1.program_id,\r\n      t1.student_id as user_id,\r\n      t1.student_code,\r\n      t1.student_name,\r\n      t1.country_id,\r\n      (select max(u.email) from `kynaforkids-server-production.kynaforkids.user` u where u.id \u003d t1.parent_id) as email,\r\n      t1.status_id,\r\n      t1.cancel_config_id,\r\n      if((t1.revenue) is null,0,(t1.revenue * if(t1.currency_exchange_rate is null, 1, t1.currency_exchange_rate))) as revenue,\r\n      if(t1.revenue is null,0,t1.revenue) as revenue_nguyen_te,\r\n      t1.payment_content\r\n    from (\r\n    SELECT \r\n      bs.id as booking_id,\r\n      bs.begin_at as booking_time,\r\n      bss.student_id,\r\n      (select booking_student.student_code from `kynaforkids-server-production.kynaforkids.booking_student` booking_student\r\n      where bs.id \u003d bss.booking_session_id and booking_student.user_id \u003d bss.student_id) as student_code,\r\n      bss.country_id as country_id ,\r\n      case \r\n      when status_id \u003d 1 then \u0027Draft\u0027\r\n      when status_id \u003d 2 then \u0027New\u0027\r\n      when status_id \u003d 3 then \u0027WaitingApprove\u0027\r\n      when status_id \u003d 4 then \u0027Approved\u0027\r\n      when status_id \u003d 5 then \u0027Completed\u0027\r\n      when status_id \u003d 6 then \u0027Rejected\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 1 then \u0027Cancelled_by_teacher\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 2 then \u0027Cancelled_by_student_without_compensate\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 3 then \u0027Cancelled_by_kyna\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 4 then \u0027Cancelled_by_student_has_compensate\u0027\r\n      when status_id \u003d 8 then \u0027Deleted\u0027\r\n      end as booking_status,\r\n      bss.revenue ,\r\n      bs.program_id,\r\n      bs.status_id,\r\n      bs.cancel_config_id,\r\n      round(bss.currency_exchange_rate,2) as currency_exchange_rate,\r\n      (select max(p.name) from `kynaforkids-server-production.kynaforkids.profile` p where p.user_id \u003d bss.student_id) as student_name,\r\n      (select max(u.parent_id) from `kynaforkids-server-production.kynaforkids.user` u where u.id \u003d bss.student_id) as parent_id,\r\n      case\r\n        when (select min(cast(bo.payment_content as INT64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo\r\n        where  bo.student_payment_id \u003d bss.student_payment_id) \u003d 1 then \u0027Buổi Học thử\u0027\r\n        when (select bph.payment_fee from `kynaforkids-server-production.kynaforkids.booking_payment_history` bph \r\n        where bph.id \u003d bss.student_payment_id) \u003d 0  then \u0027Buổi Ops tặng\u0027\r\n        else \u0027Buổi Ghi danh\u0027\r\n      end as payment_content,\r\n    FROM `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n    inner join `kynaforkids-server-production.kynaforkids.booking_session_student` bss on bs.id \u003d bss.booking_session_id \r\n    where (bs.is_compensatory_course \u003d 0 or bs.is_compensatory_course is null)) t1) t2;"
}, {
  "table_name": "Acc_Order_Tutoring_No_Students",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_Order_Tutoring_No_Students`\nAS SELECT bo.id, bo.Date, bo.Order_Code,\r\n       case\r\n              when bo.student_id is not null then ( SELECT (bs.student_code) FROM `kynaforkids-server-production.kynaforkids.booking_student` bs where bs.user_id \u003d bo.student_id)\r\n              when bo.student_id is null and (bo.student_code is not null and bo.student_code !\u003d \u0027\u0027) then bo.student_code\r\n              else bo.phone_number\r\n              end as student_code,\r\n       bo.Payment_Content,\r\n       bo.Source,\r\n       bo.Original_Price,\r\n       bo.Ex,\r\n       bo.Market,\r\n       bo.affiliate_id,\r\n       bo.lead_id,\r\n      (select ac.name from `kynaforkids-server-production.kynaforkids.affiliate_category` ac, `kynaforkids-server-production.kynaforkids.affiliate_user` au  where bo.affiliate_id \u003d au.affiliate_id and au.affiliate_category_id \u003d ac.id) as loai_affiliate,\r\n      bo.user_type_id,\r\n       -- bo.student_code_1,\r\n       bo.phone_number,\r\n       -- start adding 11/02/2025\r\n       bo.email,\r\n       bo.accounting_date,\r\n       -- end adding 11/02/2025\r\n       bo.name,\r\n       bo.total_lesson,\r\n       bo.total_gift_lesson,\r\n       bo.program_id,\r\n      (bo.total_video_course * bo.Ex) as total_video_vnd,\r\n      if(bo.company_name is not null, \u0027B2B\u0027,if(bo.event_orders is not null,\u0027Event_orders\u0027,\u0027other B2C orders\u0027)) as client_classify,\r\n      bo.company_name,\r\n      bo.tax_code\r\nFROM\r\n      (select order_ds.id,\r\n              order_kt.Date,\r\n              order_kt.Order_Code,\r\n              order_ds.student_id,\r\n              order_ds.student_code,\r\n              -- if(order_ds.student_code is null or order_ds.student_code \u003d \u0027\u0027 ,order_ds.phone_number,order_ds.student_code) as student_code,\r\n              order_kt.Payment_Content,\r\n              order_kt.Source,\r\n              order_kt.Original_Price,\r\n              order_kt.Ex, order_kt.Market,\r\n              order_ds.affiliate_id,\r\n              order_ds.lead_id,\r\n              order_ds.user_type_id,\r\n              -- order_ds.student_code as student_code_1,\r\n              order_ds.phone_number,\r\n              -- start adding 11/02/2025\r\n              order_ds.email,\r\n              if(order_ds.accounting_date is null, TIMESTAMP_SECONDS(order_ds.payment_at),TIMESTAMP_SECONDS(order_ds.accounting_date)) as accounting_date,\r\n              -- end adding 11/02/2025\r\n              order_ds.name,\r\n              order_ds.total_lesson,\r\n              order_ds.total_gift_lesson, order_ds.program_id,\r\n              if(order_ds.total_video_course is null, 0, order_ds.total_video_course) as total_video_course,\r\n              (select max(b2b.cusName) from kynaforkids-server-production.accounting_kynaforkids.Acc_B2B_order_list b2b where order_kt.Order_Code \u003d b2b.orderCode) as company_name,\r\n              (select max(b2b.taxCode) from kynaforkids-server-production.accounting_kynaforkids.Acc_B2B_order_list b2b where order_kt.Order_Code \u003d b2b.orderCode) as tax_code,\r\n              (select max(ev.invoice_code) from `kynaforkids-server-production.datateam_kynaforkids.report_order_event_offline_68c50866-e1f2-46a6-b111-ce8f51accad8` ev where order_kt.Order_Code \u003d ev.invoice_code) as event_orders\r\n      from kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt\r\n      join kynaforkids-server-production.kynaforkids.booking_order as order_ds\r\n      on order_kt.Order_Code \u003d order_ds.invoice_code) bo;"
}, {
  "table_name": "Acc_teacher_income_ex",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_teacher_income_ex`\n(\n  date DATE,\n  sellingEx FLOAT64,\n  teacherCounttry STRING,\n  currency STRING\n)\nOPTIONS(\n  sheet_range\u003d\"ex!A:D\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1VTeFIZKlUk5eRSgyIHXfHMyxvPOANvP8GAc1El5ieWA/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_tax_cash_flow_upload",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_tax_cash_flow_upload`\n(\n  date DATE,\n  doc_code STRING,\n  doc_number STRING,\n  cus_code STRING,\n  cus_name STRING,\n  description STRING,\n  account STRING,\n  corresponding_account STRING,\n  debit_amount FLOAT64,\n  credit_amount FLOAT64\n);"
}, {
  "table_name": "Acc_cash_flow_group",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_cash_flow_group`\n(\n  Date DATE,\n  Entity STRING,\n  Collection_Channel STRING,\n  Item_code STRING,\n  Description STRING,\n  Cash_in_OC FLOAT64,\n  Cash_out_OC FLOAT64,\n  Cash_in_VND FLOAT64,\n  Cash_out_VND FLOAT64,\n  Cash_in_USD FLOAT64,\n  Cash_out_USD FLOAT64,\n  Item_name STRING,\n  Forecast STRING\n)\nOPTIONS(\n  sheet_range\u003d\"Agg_Data!A:M\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1f9mCCU6Yy7NbOk-ErG4wG_GT0NFyRQH43theZRFMETA\"]\n);"
}, {
  "table_name": "Acc_tax_cash_flow_total",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_tax_cash_flow_total`\nAS SELECT * FROM `kynaforkids-server-production.accounting_kynaforkids.Acc_tax_cash_flow_live` \r\nUNION ALL\r\nSELECT * FROM  `kynaforkids-server-production.accounting_kynaforkids.Acc_tax_cash_flow_upload`;"
}, {
  "table_name": "Diep_ref_program_minutes",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Diep_ref_program_minutes`\n(\n  id INT64,\n  name STRING,\n  minutes NUMERIC,\n  hours NUMERIC\n)\nOPTIONS(\n  sheet_range\u003d\"Sheet1!A:D\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/113g6Jf9UL1P4nzkkU_9mS9SwGlvYiN6_JtxlaEj4aAo/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_invoice_tracking_upload",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_invoice_tracking_upload`\n(\n  Ngay DATE,\n  So_don_hang STRING,\n  So_hoa_don STRING,\n  So_tien FLOAT64\n);"
}, {
  "table_name": "Order_Tutoring",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring`\n(\n  Date STRING,\n  Order_Code STRING,\n  Payment_Content STRING,\n  Source STRING,\n  Original_Price FLOAT64,\n  Ex FLOAT64,\n  Market STRING,\n  Code_Contract STRING\n);"
}, {
  "table_name": "config_tutor_sale_commission",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.config_tutor_sale_commission`\n(\n  applied_date DATE,\n  type_customer STRING,\n  source STRING,\n  commission_rate FLOAT64\n);"
}, {
  "table_name": "Acc_refund_order_2022_10_01",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_refund_order_2022_10_01`\nAS select \r\n  (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id) as student_code,\r\n  (select max(p.name) from `kynaforkids-server-production.kynaforkids.profile` p where p.user_id \u003d t1.student_id) as student_name,\r\n      if(t1.type \u003d 1,(select t2.international_country_id from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id)\r\n      ,(select bst.country_id from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id)) as country_id,\r\n\r\n  -- ngaltt start\r\n    (select t2.contract_code from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id) as contract_code,\r\n  -- ngaltt end\r\n  if(t1.type \u003d 1,(select t2.email from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id),\r\n   (select max(u1.email) from `kynaforkids-server-production.kynaforkids.user` u1 where u1.id \u003d u.parent_id))\r\n  as email,\r\n  t1.program_id,\r\n  if(t1.type \u003d 1,t1.amount,0) * (select round(t2.Currency_Exchange_Rate,2) from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id) as refund_order,\r\n  if(t1.type \u003d 1,t1.amount,0) as refund_order_NT,\r\n  if(t1.type \u003d 1,if(t1.difference_amount is null,0,t1.difference_amount), 0) * \r\n  (select round(t2.Currency_Exchange_Rate,2) from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id) as difference_amount,\r\n  if(t1.type \u003d 1,if(t1.difference_amount is null,0,t1.difference_amount), 0)  as difference_amount_NT,\r\n  \r\n  -- --Nhan edit 08/12/2025: thay cac difference_amount_deactive, difference_amount_deactive_NT \u003d 0\r\n  -- 0 as difference_amount_deactive,\r\n  -- 0 as difference_amount_deactive_NT,\r\n\r\n  if(t1.type \u003d 2,if(t1.difference_amount is null,0,t1.difference_amount), 0) *\r\n  (select min(round(bo.Currency_Exchange_Rate,2)) from `kynaforkids-server-production.kynaforkids.booking_order_view` bo, \r\n    `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id and bo.student_code \u003d bst.student_code and t1.program_id \u003d bo.program_id) as difference_amount_deactive,\r\n    if(t1.type \u003d 2,if(t1.difference_amount is null,0,t1.difference_amount), 0) as difference_amount_deactive_NT,\r\n\r\n\r\n  if(t1.type \u003d 1,(select date(t2.accounting_date)from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id),date(timestamp_seconds(t1.created_at))) as refund_date\r\nfrom `kynaforkids-server-production.kynaforkids.booking_order_refund_history` t1\r\nleft join `kynaforkids-server-production.kynaforkids.user` u on u.id \u003d t1.student_id\r\n;"
}, {
  "table_name": "Acc_tax_cash_flow_live",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_tax_cash_flow_live`\n(\n  date DATE,\n  doc_code STRING,\n  doc_number STRING,\n  cus_code STRING,\n  cus_name STRING,\n  description STRING,\n  account STRING,\n  corresponding_account STRING,\n  debit_amount FLOAT64,\n  credit_amount FLOAT64\n)\nOPTIONS(\n  sheet_range\u003d\"CF-Accounting!A:J\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/10w8qGDfzxP-2SNaF6JL4p3PSBNV23pTyD6q7afxEELk/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "CEO_CAC_fixedSaleSalary",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.CEO_CAC_fixedSaleSalary`\n(\n  date DATE,\n  employeeCode STRING,\n  employeeName STRING,\n  salaryCost FLOAT64,\n  saleBonus FLOAT64,\n  yearBonus FLOAT64,\n  market STRING\n)\nOPTIONS(\n  sheet_range\u003d\"fixedSaleSalary!A:G\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1uPAxX1jOKkYFZhKrAhqNwEIhO7Qc11K484YjjzJahx8/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "CEO_CAC_fixedSaleSalary_month",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.CEO_CAC_fixedSaleSalary_month`\nAS WITH table_1 as\r\n(\r\n    SELECT \r\n\r\n    FORMAT_DATE(\u0027%Y-%m\u0027, fss.date) AS year_month,\r\n    (fss.salaryCost - fss.saleBonus - if(fss.yearBonus is null,0,fss.yearBonus)) as fixedSaleSalary,\r\n    fss.employeeCode\r\n\r\n    FROM `kynaforkids-server-production.accounting_kynaforkids.CEO_CAC_fixedSaleSalary` fss\r\n)\r\n,\r\ntable_2 as\r\n(\r\nSELECT\r\nt1.year_month,\r\nsum(t1.fixedSaleSalary) as fixedSaleSalary,\r\nCOUNT(DISTINCT t1.employeeCode) as numberEmployee\r\nFROM table_1 t1\r\nWhere t1.year_month is not null\r\nGROUP BY t1.year_month\r\nORDER BY t1.year_month desc\r\n)\r\n\r\nSELECT *, (t2.fixedSaleSalary/t2.numberEmployee) as avgFixdSalary\r\nFROM table_2 t2;"
}, {
  "table_name": "Acc_LTV_COGS",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_LTV_COGS`\n(\n  date DATE,\n  serverCost FLOAT64,\n  teacherCost FLOAT64,\n  percentGPMargin FLOAT64,\n  market STRING\n)\nOPTIONS(\n  sheet_range\u003d\"COGS!A:E\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/11CJglKZscD46EQOLhky7R1gIUDRL8-WJF9g5s0fdHvY/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_order_video",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_order_video`\nAS WITH\r\norder_ai_tutor_single AS\r\n(SELECT \r\n        (select min(order_action.created_at) from `kynaforkids-server-production.kynaforkids.order_action` order_action \r\n  where order_action.order_id \u003d ord.id and not order_action.order_status \u003d 1 ) as ngay_sale_len_don,\r\n        ord.id,\r\n        ord.completed_at,\r\n        ord.created_by,\r\n        ord.telesale_id,\r\n        ord.register_source,        \r\n        ord.country_id,\r\n        `kynaforkids-server-production.kynaforkids.func_get_country`(ord.country_id) as country,\r\n        ord.currency_exchange_rate,\r\n      --   ord.total as total_oc,\r\n        ord.sub_total,\r\n       ordd.unit_price,\r\n        ori.name as student_name,\r\n        ori.phone_number as student_phone,\r\n        ori.email as student_email,\r\n        ord.invoice_code,\r\n        case\r\n            when ord.`status` \u003d 1 then \u0027Mới tạo\u0027\r\n            when ord.`status` \u003d 2 then \u0027Xác nhận\u0027\r\n            when ord.`status` \u003d 3 then \u0027Hoàn thành\u0027\r\n            when ord.`status` \u003d 4 then \u0027Hủy\u0027\r\n            else \u0027Khác\u0027\r\n\t      end as status,\r\n        ord.payment_method_id,\r\n        ord.payment_method_status as payment_status_id,\r\n        \r\n        case when ord.invoice_code like \u0027KYNA%\u0027 then ori.lead_id\r\n             when ord.invoice_code like \u0027GRAI%\u0027 then bo.lead_id \r\n            --  (select bo.affiliate_id from `kynaforkids.booking_order` bo where RIGHT(bo.invoice_code,8) \u003d RIGHT(ord.invoice_code,8))\r\n        end as lead_id,\r\n        \r\n        case when ord.invoice_code like \u0027KYNA%\u0027 then ord.affiliate_id\r\n             when ord.invoice_code like \u0027GRAI%\u0027 then bo.affiliate_id\r\n        end as affiliate_id,\r\n      --   ord.utm_campaign,\r\n        ordd.package_id,\r\n        ordd.package_subscription_id,\r\n        pk.name as Mon_hoc,\r\n        (select pm.`name` from `kynaforkids-server-production.kynaforkids.payment_method` pm where pm.id \u003d ord.payment_method_id) as payment_method,\r\n        case\r\n      when ord.payment_method_status \u003d 1 then \u0027Chờ thanh toán\u0027\r\n      when ord.payment_method_status \u003d 2 then \u0027Đã thanh toán\u0027\r\n      when ord.payment_method_status \u003d 3 then \u0027Thanh toán thất bại\u0027\r\n      when ord.payment_method_status \u003d 4 then \u0027Chờ giao hàng\u0027\r\n \twhen ord.payment_method_status \u003d 5 then \u0027Đang giao hàng\u0027\r\n      when ord.payment_method_status \u003d 6 then \u0027Đã giao hàng\u0027\r\n      when ord.payment_method_status \u003d 7 then \u0027Đang trả hàng\u0027\r\n      when ord.payment_method_status \u003d 8 then \u0027Đã trả hàng\u0027\r\n      else null\r\n\tend as payment_status,\r\n      -- (select pg.`name` from `kynaforkids-server-production.kynaforkids.payment_gateway` pg where pg.id \u003d ord.shipping_method_id) as shipping_company,\r\n--     (select max(pt.transaction_code) from `kynaforkids-server-production.kynaforkids.payment_transaction` pt where pt.order_id \u003d ord.id) as partner_code,\r\n     if(ord.discount_amount is null,0,ord.discount_amount) as discount_amount,\r\n    if(ordd.voucher_discount_amount is null,0,ordd.voucher_discount_amount) as voucher_discount_amount,\r\n    if(ord.shipping_fee is null,0,ord.shipping_fee) as shipping_fee,\r\n    (select u.email from `kynaforkids-server-production.kynaforkids.user` u where u.id \u003d ord.created_by) as SIC,\r\n    (select max(p.name) from `kynaforkids-server-production.kynaforkids.profile` p where p.user_id \u003d ord.created_by) as SIC_name,\r\n    case\r\n    when ordd.package_combo_id is not null then\r\n    (select pcsi.package_subscription_id from `kynaforkids-server-production.kynaforkids.package_combo_subscription_item` pcsi where pcsi.id \u003d ordd.package_subscription_id and pcsi.package_id \u003d ordd.package_id)\r\n    else ordd.package_subscription_id\r\n    end as package_subscription\r\n\r\n        \r\n       \r\nFROM `kynaforkids-server-production.kynaforkids.order` ord\r\nLEFT JOIN `kynaforkids-server-production.kynaforkids.order_detail` ordd ON (ord.id \u003d ordd.order_id)\r\nLEFT JOIN `kynaforkids-server-production.kynaforkids.order_register_info` ori ON (ord.id \u003d ori.order_id)\r\n-- LEFT JOIN `kynaforkids-server-production.kynaforkids.package_subscriptions` pks ON (ordd.package_subscription_id \u003d pks.id)\r\nLEFT JOIN `kynaforkids-server-production.kynaforkids.package` pk ON (pk.id \u003d ordd.package_id)\r\n-- LEFT JOIN `kynaforkids.booking_lead` bll on bll.id \u003d ori.lead_id\r\nLEFT JOIN `kynaforkids.booking_order` bo on RIGHT(bo.invoice_code,8) \u003d RIGHT(ord.invoice_code,8)\r\n\r\n\r\n\r\n\r\nWHERE \r\n      ord.invoice_code like \u0027KYNA%\u0027 or ord.invoice_code like \u0027GRAI%\u0027\r\n--       AND pk.name like \u0027%AI Tutor%\u0027\r\n--       AND ordd.package_combo_id is null\r\n),\r\n\r\ntemp_table as (\r\nSELECT oats.*,\r\n       (SELECT us.email FROM kynaforkids-server-production.kynaforkids.user us WHERE oats.affiliate_id \u003d us.id) as affiliate_email,\r\n       (SELECT au.affiliate_category_id FROM kynaforkids-server-production.kynaforkids.affiliate_user au WHERE au.user_id \u003d oats.affiliate_id) as affiliate_category_id,\r\n        \r\n       if(oats.completed_at is null, oats.ngay_sale_len_don, oats.completed_at) as created_at,\r\n       t2.first_time_purchase_phone,\r\n       t3.first_time_purchase_email,\r\n       ps.subscription_month,\r\n       ps.name as subscription_name,\r\n       CASE WHEN(oats.sub_total !\u003d 0) then (oats.unit_price + (oats.unit_price/oats.sub_total) * (oats.shipping_fee - (oats.discount_amount + oats.voucher_discount_amount)))\r\n            WHEN (oats.sub_total\u003d0) then 0\r\n            END as total_oc,\r\n       \r\nFROM order_ai_tutor_single oats\r\n      LEFT JOIN\r\n\r\n      (select ans1.phone_number,\r\n      min(ans1.completed_at) as first_time_purchase_phone\r\n      from kynaforkids-server-production.accounting_kynaforkids.Acc_No_Students_Tutoring_AI as ans1\r\n      group by ans1.phone_number order by ans1.phone_number) t2\r\n\r\n      on oats.student_phone \u003d t2.phone_number\r\n\r\n      LEFT JOIN\r\n      \r\n      (select ans2.email,\r\n      min(ans2.completed_at) as first_time_purchase_email\r\n      from kynaforkids-server-production.accounting_kynaforkids.Acc_No_Students_Tutoring_AI as ans2\r\n      group by ans2.email order by ans2.email) t3\r\n\r\n      on oats.student_email \u003d t3.email\r\n\r\n      LEFT JOIN `kynaforkids-server-production.kynaforkids.package_subscriptions` ps ON (oats.package_subscription \u003d ps.id)\r\n)\r\n\r\nselect tt.* EXCEPT(affiliate_email),\r\n      if(bll.actual_lead_id is null, bll.utm_campaign,\r\n        (select bl.utm_campaign from `kynaforkids-server-production.kynaforkids.booking_lead` bl where bl.id \u003d bll.actual_lead_id)) as utm_campaign,\r\n      if(bll.actual_lead_id is null, bll.landing_page_name,\r\n        (select bl.landing_page_name from `kynaforkids-server-production.kynaforkids.booking_lead` bl where bl.id \u003d bll.actual_lead_id)) as landingpage_name,\r\n      -- if(bll.actual_lead_id is null, bll.affiliate_id,\r\n      --   (select bl.affiliate_id from `kynaforkids-server-production.kynaforkids.booking_lead` bl where bl.id \u003d bll.actual_lead_id)) as affiliate_id,\r\n      case when tt.invoice_code like \"KYNA%\" then tt.affiliate_email\r\n           else --if(bll.actual_lead_id is null, (select max(u.email) from `kynaforkids-server-production.kynaforkids.user` u where bll.affiliate_id \u003d u.id),\r\n      --     (select max(u.email) from `kynaforkids-server-production.kynaforkids.booking_lead` bl, `kynaforkids-server-production.kynaforkids.user` u where bll.actual_lead_id \u003d bl.id and bl.affiliate_id \u003d u.id))               \r\n                  (select max(u.email) from `kynaforkids-server-production.kynaforkids.user` u, `kynaforkids-server-production.kynaforkids.affiliate_user` au where au.affiliate_id \u003d  tt.affiliate_id and au.user_id \u003d u.id)\r\n  \r\n      end as affiliate_email,\r\n     \r\n      -- case when tt.invoice_code like \"KYNA%\" then (SELECT ac.name FROM `kynaforkids.affiliate_category` ac WHERE ac.id \u003d tt.affiliate_category_id)\r\n      --      else if (bll.actual_lead_id is null, (select ac.name from `kynaforkids-server-production.kynaforkids.affiliate_user` au, `kynaforkids-server-production.kynaforkids.affiliate_category` ac where \r\n      --     bll.affiliate_id \u003d au.user_id and au.affiliate_category_id \u003d ac.id),(select ac.name from `kynaforkids-server-production.kynaforkids.booking_lead` bl, \r\n      --     `kynaforkids-server-production.kynaforkids.affiliate_user` au, `kynaforkids-server-production.kynaforkids.affiliate_category` ac \r\n      --     where bl.id \u003d bll.actual_lead_id and bl.affiliate_id \u003d au.user_id and au.affiliate_category_id \u003d ac.id)) \r\n      -- end as affiliate_category_name,\r\n\r\n      case when tt.invoice_code like \"KYNA%\" then (SELECT ac.name FROM `kynaforkids.affiliate_category` ac WHERE ac.id \u003d tt.affiliate_category_id)\r\n           else  (select ac.name from `kynaforkids-server-production.kynaforkids.affiliate_category` ac, `kynaforkids-server-production.kynaforkids.affiliate_user` au  where \r\n      tt.affiliate_id \u003d au.affiliate_id and au.affiliate_category_id \u003d ac.id)\r\n      end as affiliate_category_name,\r\n\r\n\r\nfrom temp_table tt\r\nleft join `kynaforkids.booking_lead` bll on tt.lead_id \u003d bll.id\r\n-- left join `kynaforkids.booking_order` bo on bo.lead_id \u003d tt.lead_id\r\n\r\n;"
}, {
  "table_name": "Acc_Doanhthuphanbo_booking_2022_10_01_not_Ops_tang",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_Doanhthuphanbo_booking_2022_10_01_not_Ops_tang`\nAS SELECT * FROM\r\n\r\n    (select \r\n      date(t1.booking_time) as begin_at,\r\n      t1.booking_id,\r\n      t1.program_id,\r\n      t1.student_id as user_id,\r\n      t1.student_code,\r\n      t1.student_name,\r\n      t1.country_id,\r\n      (select max(u.email) from `kynaforkids-server-production.kynaforkids.user` u where u.id \u003d t1.parent_id) as email,\r\n      t1.status_id,\r\n      t1.cancel_config_id,\r\n      if((t1.revenue) is null,0,(t1.revenue * if(t1.currency_exchange_rate is null, 1, t1.currency_exchange_rate))) as revenue,\r\n      if(t1.revenue is null,0,t1.revenue) as revenue_nguyen_te,\r\n      t1.payment_content\r\n    from (\r\n    SELECT \r\n      bs.id as booking_id,\r\n      bs.begin_at as booking_time,\r\n      bss.student_id,\r\n      (select booking_student.student_code from `kynaforkids-server-production.kynaforkids.booking_student` booking_student\r\n      where bs.id \u003d bss.booking_session_id and booking_student.user_id \u003d bss.student_id) as student_code,\r\n      bss.country_id as country_id ,\r\n      case \r\n      when status_id \u003d 1 then \u0027Draft\u0027\r\n      when status_id \u003d 2 then \u0027New\u0027\r\n      when status_id \u003d 3 then \u0027WaitingApprove\u0027\r\n      when status_id \u003d 4 then \u0027Approved\u0027\r\n      when status_id \u003d 5 then \u0027Completed\u0027\r\n      when status_id \u003d 6 then \u0027Rejected\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 1 then \u0027Cancelled_by_teacher\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 2 then \u0027Cancelled_by_student_without_compensate\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 3 then \u0027Cancelled_by_kyna\u0027\r\n      when status_id \u003d 7 and bs.cancel_config_id \u003d 4 then \u0027Cancelled_by_student_has_compensate\u0027\r\n      when status_id \u003d 8 then \u0027Deleted\u0027\r\n      end as booking_status,\r\n      bss.revenue ,\r\n      bs.program_id,\r\n      bs.status_id,\r\n      bs.cancel_config_id,\r\n      bss.currency_exchange_rate,\r\n      (select max(p.name) from `kynaforkids-server-production.kynaforkids.profile` p where p.user_id \u003d bss.student_id) as student_name,\r\n      (select max(u.parent_id) from `kynaforkids-server-production.kynaforkids.user` u where u.id \u003d bss.student_id) as parent_id,\r\n      case\r\n        when (select min(cast(bo.payment_content as INT64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo\r\n        where  bo.student_payment_id \u003d bss.student_payment_id) \u003d 1 then \u0027Buổi Học thử\u0027\r\n        when (select bph.payment_fee from `kynaforkids-server-production.kynaforkids.booking_payment_history` bph \r\n        where bph.id \u003d bss.student_payment_id) \u003d 0  then \u0027Buổi Ops tặng\u0027\r\n        else \u0027Buổi Ghi danh\u0027\r\n      end as payment_content,\r\n    FROM `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n    inner join `kynaforkids-server-production.kynaforkids.booking_session_student` bss on bs.id \u003d bss.booking_session_id \r\n    where (bs.is_compensatory_course \u003d 0 or bs.is_compensatory_course is null)) t1) t2\r\n\r\nWHERE t2.payment_content not in (\u0027Buổi Ops tặng\u0027);"
}, {
  "table_name": "Acc_NewStudent_FirstTimePurchase",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_NewStudent_FirstTimePurchase`\nAS SELECT *, (select lll.name from `kynaforkids-server-production.kynaforkids.location` lll where lll.id \u003d t4.location_id ) as location_name\r\nFROM\r\n   (SELECT t3.student_code, t3.phone_number, t3.first_time_purchase, if(ll.parent_id \u003d 0, ll.id,ll.parent_id) as location_id\r\n   FROM\r\n\r\n      (SELECT t2.student_code, t2.phone_number, t2.first_time_purchase, if(l.parent_id \u003d 0,l.id,l.parent_id) as location_id\r\n      FROM\r\n\r\n         (SELECT\r\n         t1.student_code as student_code,\r\n         t1.phone_number as phone_number,\r\n         min(date(t1.accounting_date)) as first_time_purchase,\r\n         if(max(t1.location_id_gift) is null, if(max(t1.location_id_lead) is null, null,max(t1.location_id_lead)),max(t1.location_id_gift)) as location_id\r\n         FROM\r\n            (SELECT\r\n               if(bo.student_code is null or bo.student_code \u003d \u0027\u0027,bo.phone_number,bo.student_code) AS student_code,\r\n               bo.phone_number,\r\n               if(bo.accounting_date is null ,bo.payment_at,bo.accounting_date) AS accounting_date,\r\n               bl.location_id as location_id_lead,\r\n               bog.location_id as location_id_gift\r\n               FROM `kynaforkids-server-production.kynaforkids.booking_order_view`  bo\r\n               LEFT JOIN `kynaforkids-server-production.kynaforkids.booking_lead`  bl on bo.lead_id \u003d bl.id\r\n               LEFT JOIN \r\n               (select left(g.invoice_code,13) as invoice_code, g.location_id from `kynaforkids-server-production.kynaforkids.booking_order_gift` g)  bog on bo.invoice_code \u003d bog.invoice_code\r\n\r\n               WHERE bo.payment_status in (1)\r\n            ) t1\r\n         GROUP BY t1.student_code, t1.phone_number) t2\r\n\r\n      left join `kynaforkids-server-production.kynaforkids.location` l on l.id \u003d t2.location_id) t3\r\n\r\n   left join `kynaforkids-server-production.kynaforkids.location` ll on ll.id \u003d t3.location_id) t4\r\n;"
}, {
  "table_name": "Acc_Doanhthu_order_2022_10_01_inc_lessons",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_Doanhthu_order_2022_10_01_inc_lessons`\nAS WITH table_1 AS (\r\n  SELECT *,\r\n    if(student_code is null and student_id is not null, (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d bo.student_id), student_code) as ma_hoc_vien\r\n\r\n  FROM `kynaforkids-server-production.kynaforkids.booking_order_view` bo\r\n\r\n  where bo.program_type \u003d 1\r\n\r\n)\r\n\r\nSelect \r\n    date(t1.accounting_date) as accounting_date,\r\n    -- (select bsp.user_id from `kynaforkids-server-production.kynaforkids.booking_student` bst, `kynaforkids-server-production.kynaforkids.booking_student_program` bsp where bo.student_code \u003d bst.student_code and bst.user_id \u003d bsp.user_id and bsp.program_id \u003d bo.program_id) as user_id,\r\n    t1.ma_hoc_vien,\r\n    -- (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d bo.student_id) as ma_hoc_vien,\r\n\t\t-- bo.student_code as ma_hoc_vien,\r\n\t\t-- (select max(p.`name`) \r\n\t\t  --from `kynaforkids-server-production.kynaforkids.profile`  p , `kynaforkids-server-production.kynaforkids.booking_student`  bst\r\n        --    where bst.student_code \u003d bo.student_code \r\n          --  and p.user_id \u003d bst.user_id) \r\n\t\t--as student_name,\r\n\t\t-- max(t1.email) as email,\r\n    max(t1.phone_number) as phone_number,\r\n    max(t1.international_country_id) as country_id,\r\n    -- ngaltt start\r\n    max(t1.currency_code) as currency_code,\r\n    max(t1.contract_code) as contract_code,\r\n    -- ngaltt end\r\n    max(t1.currency_exchange_rate) as currency_exchange_rate,\r\n    sum((t1.total * t1.currency_exchange_rate) + (t1.total_video_course * t1.currency_exchange_rate)) - sum(if(t1.discount_money is null, 0, (t1.discount_money * t1.currency_exchange_rate))) \r\n    as tong_thu_has_video_course,\r\n    sum(t1.total * t1.currency_exchange_rate) - sum(if(t1.discount_money is null, 0, (t1.discount_money * t1.currency_exchange_rate))) \r\n    as tong_thu,\r\n    sum(t1.total) - sum(if(t1.discount_money is null, 0, t1.discount_money)) as tong_thu_nguyen_te,\r\n    sum(t1.total_video_course * t1.currency_exchange_rate) as total_video_vnd,\r\n    t1.program_id,\r\n  \u0027\u0027 as invoice_code,\r\n  sum(t1.total_lesson + t1.total_gift_lesson) as total_lesson\r\n\r\nfrom table_1  t1\r\nwhere t1.payment_status \u003d 1 \r\n\tand t1.ma_hoc_vien is not null \r\ngroup by t1.ma_hoc_vien, t1.program_id, date(t1.accounting_date)\r\n\r\nunion all \r\n\r\nSelect \r\n  date(t2.accounting_date) as accounting_date,\r\n  -- 0 as user_id,\r\n\t\u0027\u0027 as ma_hoc_vien,   \r\n  --\u0027\u0027 as student_name,\r\n\t-- t2.email as email,\r\n  t2.phone_number as phone_number,\r\n      max(t2.international_country_id) as country_id,\r\n  -- ngaltt start\r\n  max(t2.currency_code) as currency_code,\r\n  max(t2.contract_code) as contract_code,\r\n  -- ngaltt end\r\n  max(t2.currency_exchange_rate) as currency_exchange_rate,\r\n  sum((t2.total * t2.currency_exchange_rate) + (t2.total_video_course * t2.currency_exchange_rate)) - \r\n    sum(if(t2.discount_money is null, 0, (t2.discount_money * t2.currency_exchange_rate))) as tong_thu_has_video_course,\r\n  sum(t2.total * t2.currency_exchange_rate) - sum(if(t2.discount_money is null, 0, (t2.discount_money * t2.currency_exchange_rate))) \r\n  as tong_thu,\r\n  sum(t2.total) - sum(if(t2.discount_money is null, 0, t2.discount_money)) as tong_thu_nguyen_te,\r\n  sum(t2.total_video_course * t2.currency_exchange_rate) as total_video_vnd,\r\n  t2.program_id,\r\n  string_agg(t2.invoice_code) as invoice_code,\r\n  sum(t2.total_lesson + t2.total_gift_lesson) as total_lesson\r\n\r\nfrom table_1  t2\r\nwhere t2.payment_status \u003d 1 \r\n  and t2.ma_hoc_vien is null \r\ngroup by t2.phone_number, t2.program_id, date(t2.accounting_date)  ;"
}, {
  "table_name": "Acc_No_Students_Tutoring_AI",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_No_Students_Tutoring_AI`\nAS \t\r\n\t\tSELECT if(o.completed_at is null,o.created_at,o.completed_at) as completed_at,\r\n\t\t\t\t\to.invoice_code,\r\n\t\t\t\t\t(select ori.email from `kynaforkids-server-production.kynaforkids.order_register_info` ori where ori.order_id \u003d o.id) as email,\r\n\t\t\t\t\t(select ori.phone_number from `kynaforkids-server-production.kynaforkids.order_register_info` ori where ori.order_id \u003d o.id) as phone_number,\r\n\t\tfrom `kynaforkids-server-production.kynaforkids.order` o\r\n\t\twhere o.status \u003d 3\r\n\r\n\t\tUNION ALL\r\n\r\n\t\tSELECT if(bo.accounting_date is null, bo.created_at, bo.accounting_date) as completed_at,\r\n\t\t\t\t\tbo.invoice_code,\r\n\t\t\t\t\tbo.email,\r\n\t\t\t\t\tbo.phone_number,\r\n\t\tfrom `kynaforkids-server-production.kynaforkids.booking_order` bo\r\n\t\twhere bo.approved_status \u003d 1;"
}, {
  "table_name": "Diep_student_remaining_lesson",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Diep_student_remaining_lesson`\nAS SELECT *,\r\n (select max(bl.location_id) from `kynaforkids-server-production.kynaforkids.booking_lead` bl \r\n    where bl.email \u003d t2.email) as location_id\r\n FROM\r\n  (\r\n  SELECT *,\r\n  (select max(u.email) from `kynaforkids-server-production.kynaforkids.user` u \r\n      where t1.parent_id \u003d u.id) as email\r\n  FROM\r\n    (\r\n    SELECT *,\r\n      (select rft.minDate from `kynaforkids-server-production.accounting_kynaforkids.learning_retention_first_time` rft \r\n            where rft.student_id \u003d bsp.user_id) as minDate,\r\n      (select max(u.parent_id) from `kynaforkids-server-production.kynaforkids.user` u \r\n            where u.id \u003d bsp.user_id)  as parent_id,\r\n      (select max(p.birthday) from `kynaforkids-server-production.kynaforkids.profile` p \r\n      where p.user_id \u003d bsp.user_id) as birthday\r\n      \r\n    FROM `kynaforkids-server-production.kynaforkids.booking_student_program` bsp ) t1 ) t2;"
}, {
  "table_name": "Acc_program_level_age_classification",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_program_level_age_classification`\n(\n  program STRING,\n  level STRING,\n  age STRING,\n  classification STRING\n);"
}, {
  "table_name": "Acc_LTV_Booking_FirstTimePurchase",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_LTV_Booking_FirstTimePurchase`\nAS SELECT \r\n  t1.booking_id,\r\n  t1.user_type,\r\n  t1.begin_at,\r\n  if((t1.revenue) is null,0,(t1.revenue * if(t1.currency_exchange_rate is null, 1, t1.currency_exchange_rate))) as revenue,\r\n  if(t1.revenue is null,0,t1.revenue) as revenue_nguyen_te,\r\n  t1.program_type,\r\n  t1.program_name,\r\n  t1.student_code,\r\n  t1.student_name,\r\n  t1.student_country,\r\n  t1.payment_content,\r\n  (select ftp.first_time_purchase from `kynaforkids-server-production.accounting_kynaforkids.Acc_NewStudent_FirstTimePurchase` ftp \r\n        where ftp.student_code \u003d t1.student_code) as first_time_purchase\r\n        \r\n      FROM (\r\n        SELECT \r\n            bs.id as booking_id,\r\n            case \r\n              when (select btu.user_type_id from `kynaforkids-server-production.kynaforkids.booking_student` btu \r\n                where btu.user_id \u003d bss.student_id) \u003d 1 then \u0027Kid\u0027\r\n              when (select btu.user_type_id from `kynaforkids-server-production.kynaforkids.booking_student` btu \r\n                where btu.user_id \u003d bss.student_id) \u003d 2 then \u0027Adult\u0027\r\n            end as user_type,\r\n            bs.begin_at,\r\n            bss.revenue,\r\n          case \r\n          when bs.program_id in (5,14,15,21,22,46,61,62,63,64,65,67) then \u0027Group class\u0027\r\n          else \u00271-1\u0027\r\n          end as program_type,\r\n          `kynaforkids-server-production.kynaforkids.func_get_program_name_from_id`(bs.program_id) as program_name,\r\n        (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d bss.student_id) as student_code,\r\n          (select max(p.`name`) from `kynaforkids-server-production.kynaforkids.profile` p where bs.id \u003d bss.booking_session_id and p.user_id \u003d bss.student_id) as student_name,\r\n        `kynaforkids-server-production.kynaforkids.func_get_booking_student_country`((select bst.country_id from  `kynaforkids-server-production.kynaforkids.booking_student` bst \r\n        where bs.id \u003d bss.booking_session_id and bss.student_id \u003d bst.user_id)) as student_country,\r\n        bs.status_id,\r\n        bs.cancel_config_id,\r\n        bss.currency_exchange_rate,\r\n        case\r\n          when (select min(cast(bo.payment_content as INT64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo\r\n          where  bo.student_payment_id \u003d bss.student_payment_id) \u003d 1 then \u0027Buổi Học thử\u0027\r\n          when (select bph.payment_fee from `kynaforkids-server-production.kynaforkids.booking_payment_history` bph \r\n          where bph.id \u003d bss.student_payment_id) \u003d 0  then \u0027Buổi tặng\u0027\r\n          else \u0027Buổi Ghi danh\u0027\r\n        end as payment_content\r\n        FROM `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n        left join `kynaforkids-server-production.kynaforkids.booking_session_student` bss on bs.id\u003dbss.booking_session_id \r\n        where bs.program_id not in (3,8,13,47,48,53,54,55,56) \r\n        and (bs.status_id in (5) or (bs.status_id \u003d 7 and bs.cancel_config_id in (2)))\r\n        and (select min(cast(bo.payment_content as INt64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo,\r\n    `kynaforkids-server-production.kynaforkids.booking_session_student` bst \r\n    where bst.booking_session_id \u003d bs.id   and bo.student_payment_id \u003d bst.student_payment_id) !\u003d 1\r\n    order by bss.student_id desc\r\n        ) t1;"
}, {
  "table_name": "Recruitment_Booking",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Recruitment_Booking`\n(\n  Date INT64,\n  Month INT64,\n  Year INT64,\n  Recruit_Code STRING,\n  Dept STRING,\n  Position STRING,\n  Level STRING,\n  Location STRING,\n  Headcounts INT64,\n  Recruit_Reason STRING,\n  Booking_Status STRING,\n  Notes STRING,\n  Link_JD STRING,\n  Priority INT64\n)\nOPTIONS(\n  sheet_range\u003d\"Recruitment_Booking!A:N\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/1pg6ZrDtlh9MivSC5kkwyiORdIhjTj_lnG-OpJasJjNI/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_LTV_CAC",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_LTV_CAC`\n(\n  date DATE,\n  sellingCost FLOAT64,\n  cacCost FLOAT64,\n  market STRING\n)\nOPTIONS(\n  sheet_range\u003d\"CAC!A:D\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/11CJglKZscD46EQOLhky7R1gIUDRL8-WJF9g5s0fdHvY/edit?usp\u003dsharing \"]\n);"
}, {
  "table_name": "Invoice_tracking",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Invoice_tracking`\n(\n  Ngay DATE,\n  So_don_hang STRING,\n  So_hoa_don STRING,\n  So_tien FLOAT64\n)\nOPTIONS(\n  sheet_range\u003d\"Invoice_Tutoring!A:D\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/19bAcdp5aC9HtMs5J4OBGGhsLGAUq21WB4gvCf0N7hkw\"]\n);"
}, {
  "table_name": "Acc_structure_revenue_tutoring",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_structure_revenue_tutoring`\nAS SELECT \r\n  DISTINCT(t1.id),\r\n  t1.student_code,\r\n  t1.student_id,\r\n  `kynaforkids-server-production.kynaforkids.func_get_country`(t1.student_country_id) as student_country,\r\n  t1.minDate,\r\n  t1.learning_month,\r\n  t1.learning_year,\r\n  t1.order_date,\r\n  t1.begin_at,\r\n  t1.revenue,\r\n  if((t1.revenue) is null,0,(t1.revenue * if(t1.currency_exchange_rate is null, 1, t1.currency_exchange_rate))) as revenue_vnd,\r\n  t1.booking_status,\r\n  t1.payment_content,\r\n  t1.program\r\nFROM\r\n    \r\n    (SELECT \r\n        bs.id,\r\n        bss.student_id as student_id, \r\n        (select max(u.parent_id) from `kynaforkids-server-production.kynaforkids.user` u \r\n          where u.id \u003d bss.student_id)  as parent_id,\r\n        (select rft.minDate from `kynaforkids-server-production.accounting_kynaforkids.learning_retention_first_time` rft \r\n          where rft.student_id \u003d bss.student_id) as minDate,\r\n        FORMAT_TIMESTAMP(\"%m/%Y\", bs.begin_at) as learning_month,\r\n        FORMAT_TIMESTAMP(\"%Y\", bs.begin_at) as learning_year,\r\n        (select max(bo.accounting_date) from `kynaforkids-server-production.kynaforkids.booking_order` bo where \r\n          bo.student_payment_id \u003d bss.student_payment_id and bo.payment_status \u003d 1 and bo.payment_content in (1,2,3,4)) \r\n          as order_date,\r\n        bs.begin_at,\r\n        bss.revenue,\r\n        bss.currency_exchange_rate,\r\n    (select pro.name from `kynaforkids-server-production.kynaforkids.booking_program` pro where bs.program_id \u003d pro.id) as program,\r\n    (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d bss.student_id) as student_code,\r\n    (select bst.country_id from  `kynaforkids-server-production.kynaforkids.booking_student` bst where bs.id \u003d bss.booking_session_id and bss.student_id \u003d bst.user_id) as student_country_id,\r\n     case \r\n        when bs.status_id \u003d 1 then \u0027Draft\u0027\r\n        when bs.status_id \u003d 2 then \u0027New\u0027\r\n        when bs.status_id \u003d 3 then \u0027WaitingApprove\u0027\r\n        when bs.status_id \u003d 4 then \u0027Approved\u0027\r\n        when bs.status_id \u003d 5 then \u0027Completed\u0027\r\n        when bs.status_id \u003d 6 then \u0027Rejected\u0027\r\n        when bs.status_id \u003d 7 and bs.cancel_config_id \u003d 1 then \u0027Cancelled_by_teacher\u0027\r\n        when bs.status_id \u003d 7 and bs.cancel_config_id \u003d 2 then \u0027Cancelled_by_student_without_compensate\u0027\r\n        when bs.status_id \u003d 7 and bs.cancel_config_id \u003d 3 then \u0027Cancelled_by_kyna\u0027\r\n        when bs.status_id \u003d 7 and bs.cancel_config_id \u003d 4 then \u0027Cancelled_by_student_has_compensate\u0027\r\n        when bs.status_id \u003d 8 then \u0027Deleted\u0027\r\n        end as booking_status,\r\n    case\r\n      when (select min(cast(bo.payment_content as INT64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo\r\n      where  bo.student_payment_id \u003d bss.student_payment_id) \u003d 1 then \u0027Buổi Học thử\u0027\r\n      when (select bph.payment_fee from `kynaforkids-server-production.kynaforkids.booking_payment_history` bph \r\n      where bph.id \u003d bss.student_payment_id) \u003d 0  then \u0027Buổi tặng\u0027\r\n      else \u0027Buổi Ghi danh\u0027\r\n    end as payment_content,\r\n    FROM `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n    left join `kynaforkids-server-production.kynaforkids.booking_session_student` bss on bs.id\u003dbss.booking_session_id \r\n    where bs.program_id not in (select id from `kynaforkids-server-production.kynaforkids.booking_program`where  type in (2,3)) \r\n          and status_id in (5,7)\r\n    and \r\n      (select min(cast(bo.payment_content as INt64)) from `kynaforkids-server-production.kynaforkids.booking_order` bo,\r\n      `kynaforkids-server-production.kynaforkids.booking_session_student` bst \r\n      where bst.booking_session_id \u003d bs.id   and bo.student_payment_id \u003d bst.student_payment_id) !\u003d 1\r\n      order by bss.student_id desc) t1;"
}, {
  "table_name": "Acc_invoice_tracking_live",
  "ddl": "CREATE EXTERNAL TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_invoice_tracking_live`\n(\n  Ngay DATE,\n  So_don_hang STRING,\n  So_hoa_don STRING,\n  So_tien FLOAT64\n)\nOPTIONS(\n  sheet_range\u003d\"Invoice_Tutoring!A:D\",\n  skip_leading_rows\u003d1,\n  format\u003d\"GOOGLE_SHEETS\",\n  uris\u003d[\"https://docs.google.com/spreadsheets/d/19bAcdp5aC9HtMs5J4OBGGhsLGAUq21WB4gvCf0N7hkw/edit?usp\u003dsharing\"]\n);"
}, {
  "table_name": "Acc_refund_order_2022_10_01_inc_lessons",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_refund_order_2022_10_01_inc_lessons`\nAS select \r\n  (select bst.student_code from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id) as student_code,\r\n  (select max(p.name) from `kynaforkids-server-production.kynaforkids.profile` p where p.user_id \u003d t1.student_id) as student_name,\r\n      if(t1.type \u003d 1,(select t2.international_country_id from `kynaforkids-server-production.kynaforkids.booking_order` t2 where t2.id \u003d t1.order_id)\r\n      ,(select bst.country_id from `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id)) as country_id,\r\n\r\n  -- ngaltt start\r\n    (select t2.contract_code from `kynaforkids-server-production.kynaforkids.booking_order` t2 where t2.id \u003d t1.order_id) as contract_code,\r\n  -- ngaltt end\r\n  if(t1.type \u003d 1,(select t2.email from `kynaforkids-server-production.kynaforkids.booking_order` t2 where t2.id \u003d t1.order_id),\r\n   (select max(u1.email) from `kynaforkids-server-production.kynaforkids.user` u1 where u1.id \u003d u.parent_id))\r\n  as email,\r\n  t1.program_id,\r\n  if(t1.type \u003d 1,t1.amount,0) * (select t2.Currency_Exchange_Rate from `kynaforkids-server-production.kynaforkids.booking_order` t2 where t2.id \u003d t1.order_id) as refund_order,\r\n  if(t1.type \u003d 1,t1.amount,0) as refund_order_NT,\r\n  if(t1.type \u003d 1,if(t1.difference_amount is null,0,t1.difference_amount), 0) * \r\n  (select t2.Currency_Exchange_Rate from `kynaforkids-server-production.kynaforkids.booking_order` t2 where t2.id \u003d t1.order_id) as difference_amount,\r\n  if(t1.type \u003d 1,if(t1.difference_amount is null,0,t1.difference_amount), 0)  as difference_amount_NT,\r\n  if(t1.type \u003d 2,if(t1.difference_amount is null,0,t1.difference_amount), 0) *\r\n  (select min(bo.Currency_Exchange_Rate) from `kynaforkids-server-production.kynaforkids.booking_order` bo, \r\n    `kynaforkids-server-production.kynaforkids.booking_student` bst where bst.user_id \u003d t1.student_id and bo.student_code \u003d bst.student_code and t1.program_id \u003d bo.program_id) as difference_amount_deactive,\r\n    if(t1.type \u003d 2,if(t1.difference_amount is null,0,t1.difference_amount), 0) as difference_amount_deactive_NT,\r\n  if(t1.type \u003d 1,(select date(t2.accounting_date)from `kynaforkids-server-production.kynaforkids.booking_order_view` t2 where t2.id \u003d t1.order_id),date(timestamp_seconds(t1.created_at))) as refund_date,\r\n  t1.remain_lesson\r\nfrom `kynaforkids-server-production.kynaforkids.booking_order_refund_history` t1\r\nleft join `kynaforkids-server-production.kynaforkids.user` u on u.id \u003d t1.student_id\r\n;"
}, {
  "table_name": "Acc_Doanhthu_order_2022_10_01",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.Acc_Doanhthu_order_2022_10_01`\nAS Select \r\n    date(bo.accounting_date) as accounting_date,\r\n    (select bsp.user_id from `kynaforkids-server-production.kynaforkids.booking_student` bst, `kynaforkids-server-production.kynaforkids.booking_student_program` bsp where bo.student_code \u003d bst.student_code and bst.user_id \u003d bsp.user_id and bsp.program_id \u003d bo.program_id) as user_id,\r\n\t\tbo.student_code as ma_hoc_vien,\r\n\t\t(select max(p.`name`) \r\n\t\t  from `kynaforkids-server-production.kynaforkids.profile`  p , `kynaforkids-server-production.kynaforkids.booking_student`  bst\r\n            where bst.student_code \u003d bo.student_code \r\n            and p.user_id \u003d bst.user_id) \r\n\t\tas student_name,\r\n\t\tmax(bo.email) as email,\r\n    max(bo.phone_number) as phone_number,\r\n    max(bo.international_country_id) as country_id,\r\n    -- ngaltt start\r\n    max(bo.currency_code) as currency_code,\r\n    max(bo.contract_code) as contract_code,\r\n    -- ngaltt end\r\n    max(round(bo.currency_exchange_rate,2)) as currency_exchange_rate,\r\n    sum((bo.total * round(bo.currency_exchange_rate,2)) + (bo.total_video_course * round(bo.currency_exchange_rate,2))) - sum(if(bo.discount_money is null, 0, (bo.discount_money * round(bo.currency_exchange_rate,2)))) \r\n    as tong_thu_has_video_course,\r\n    sum(bo.total * round(bo.currency_exchange_rate,2)) - sum(if(bo.discount_money is null, 0, (bo.discount_money * round(bo.currency_exchange_rate,2)))) \r\n    as tong_thu,\r\n    sum(bo.total) - sum(if(bo.discount_money is null, 0, bo.discount_money)) as tong_thu_nguyen_te,\r\n    sum(bo.total_video_course * round(bo.currency_exchange_rate,2)) as total_video_vnd,\r\n    bo.program_id,\r\n  \u0027\u0027 as invoice_code\r\nfrom `kynaforkids-server-production.kynaforkids.booking_order_view`  bo\r\nwhere bo.payment_status \u003d 1\r\n-- diep start 28-02-2025\r\n  and bo.program_type \u003d 1\r\n-- diep end 28-02-2025 \r\n\tand bo.student_code is not null \r\n  and trim(bo.student_code) !\u003d \u0027\u0027\r\ngroup by bo.student_code, bo.program_id, date(bo.accounting_date)\r\n\r\nunion all \r\n\r\nSelect \r\n  date(bo.accounting_date) as accounting_date,\r\n  0 as user_id,\r\n\t\u0027\u0027 as ma_hoc_vien,   \r\n  \u0027\u0027 as student_name,\r\n\tbo.email as email,\r\n  max(bo.phone_number) as phone_number,\r\n      max(bo.international_country_id) as country_id,\r\n  -- ngaltt start\r\n  max(bo.currency_code) as currency_code,\r\n  max(bo.contract_code) as contract_code,\r\n  -- ngaltt end\r\n  max(round(bo.currency_exchange_rate,2)) as currency_exchange_rate,\r\n  sum((bo.total * round(bo.currency_exchange_rate,2)) + (bo.total_video_course * round(bo.currency_exchange_rate,2))) - \r\n    sum(if(bo.discount_money is null, 0, (bo.discount_money * round(bo.currency_exchange_rate,2)))) as tong_thu_has_video_course,\r\n  sum(bo.total * round(bo.currency_exchange_rate,2)) - sum(if(bo.discount_money is null, 0, (bo.discount_money * round(bo.currency_exchange_rate,2)))) \r\n  as tong_thu,\r\n  sum(bo.total) - sum(if(bo.discount_money is null, 0, bo.discount_money)) as tong_thu_nguyen_te,\r\n  sum(bo.total_video_course * round(bo.currency_exchange_rate,2)) as total_video_vnd,\r\n  bo.program_id,\r\n  string_agg(bo.invoice_code) as invoice_code\r\nfrom `kynaforkids-server-production.kynaforkids.booking_order_view`  bo\r\nwhere bo.payment_status \u003d 1 \r\n-- diep start 28-02-2025\r\n  and bo.program_type \u003d 1\r\n-- diep end 28-02-2025\r\n  and (bo.student_code is null or trim(bo.student_code) \u003d\u0027\u0027)\r\ngroup by bo.email, bo.program_id, date(bo.accounting_date)  ;"
}, {
  "table_name": "Acc_teacher_income_upload",
  "ddl": "CREATE TABLE `kynaforkids-server-production.accounting_kynaforkids.Acc_teacher_income_upload`\n(\n  date DATE,\n  item_type STRING,\n  teacher_type STRING,\n  teacher_code STRING,\n  teacher_name STRING,\n  amount_oc FLOAT64,\n  ex FLOAT64,\n  amount_vnd FLOAT64,\n  id INT64\n);"
}, {
  "table_name": "tutoring_customer_by_order",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.tutoring_customer_by_order`\nAS (select t1.Date as month_kt,t1.Order_Code, t1.phone_number as Phone_Number, t1.accounting_date as purchase_date, t3.first_time_purchase_phone as first_time_purchase_phone, t1.email as Email, t33.first_time_purchase_email as first_time_purchase_email ,t1.Source, sum(if(t1.Original_Price is null or t1.Original_Price \u003d 0,0,t1.Original_Price)) as Original_Price, round(sum(if(t1.Original_Price is null or t1.Original_Price \u003d 0,0,t1.Original_Price)*t1.Ex),0) as VND_Price, \r\n  case\r\n  when t1.accounting_date \u003d t3.first_time_purchase_phone then \u0027New\u0027\r\n  else \u0027Old\u0027\r\n  end as type_order_phone,\r\n  case\r\n  when t1.accounting_date \u003d t33.first_time_purchase_email then \u0027New\u0027\r\n  else \u0027Old\u0027\r\n  end as type_order_email,\r\n  t1.Payment_Content\r\nfrom\r\n(select\r\norder_kt.Date , if(order_ds.accounting_date is null,order_ds.created_at,order_ds.accounting_date) as accounting_date, order_kt.Order_Code, order_ds.phone_number, order_kt.Payment_Content, order_kt.Source, order_kt.Original_Price, order_kt.Ex, order_kt.Market, order_ds.email\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds\r\non order_kt.Order_Code \u003d order_ds.invoice_code\r\nwhere order_kt.Payment_Content in (\u0027Học thử\u0027) and order_kt.Code_Contract is null ) t1\r\n\r\nfull join\r\n\r\n(select t2.phone_number,\r\nmin(t2.accounting_date) as first_time_purchase_phone\r\nfrom (select\r\nif(order_ds2.accounting_date is null,order_ds2.created_at,order_ds2.accounting_date)  as accounting_date , order_kt2.Order_Code, order_ds2.phone_number\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt2\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds2\r\non order_kt2.Order_Code \u003d order_ds2.invoice_code\r\nwhere order_kt2.Payment_Content not in (\u0027Đơn hoàn tiền\u0027,\u0027Hoàn tiền\u0027) and order_kt2.Code_Contract is null) t2\r\ngroup by t2.phone_number order by t2.phone_number) t3\r\n\r\non t1.phone_number \u003d t3.phone_number\r\n\r\n\r\nfull join\r\n\r\n(select t22.email,\r\nmin(t22.accounting_date) as first_time_purchase_email\r\nfrom (select\r\nif(order_ds22.accounting_date is null,order_ds22.created_at,order_ds22.accounting_date)  as accounting_date , order_kt22.Order_Code, order_ds22.email\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt22\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds22\r\non order_kt22.Order_Code \u003d order_ds22.invoice_code\r\nwhere order_kt22.Payment_Content not in (\u0027Đơn hoàn tiền\u0027,\u0027Hoàn tiền\u0027) and order_kt22.Code_Contract is null) t22\r\ngroup by t22.email order by t22.email) t33\r\n\r\non t1.email \u003d t33.email\r\n\r\n  \r\n  \r\ngroup by Order_Code, Phone_Number, month_kt, purchase_date, first_time_purchase_phone, Email, first_time_purchase_email , Payment_Content, Source)\r\n\r\n\r\nunion all\r\n\r\n(select t4.Date as month_kt, t4.Order_Code, t4.phone_number as Phone_Number, t4.accounting_date as purchase_date, t6.first_time_purchase_phone as first_time_purchase_phone,t4.email as Email, t66.first_time_purchase_email as first_time_purchase_email ,t4.Source ,sum(if(t4.Original_Price is null or t4.Original_Price \u003d 0,0,t4.Original_Price)) as Original_Price, round(sum(if(t4.Original_Price is null or t4.Original_Price \u003d 0,0,t4.Original_Price)*t4.Ex),0) as VND_Price, \r\n  case\r\n  when t4.accounting_date \u003d t6.first_time_purchase_phone then \u0027New\u0027\r\n  else \u0027Old\u0027\r\n  end as type_order_phone,\r\n  case\r\n  when t4.accounting_date \u003d t66.first_time_purchase_email then \u0027New\u0027\r\n  else \u0027Old\u0027\r\n  end as type_order_email,\r\n  t4.Payment_Content\r\nfrom\r\n(select\r\norder_kt3.Date, if(order_ds3.accounting_date is null,order_ds3.created_at,order_ds3.accounting_date)  as accounting_date, order_kt3.Order_Code, order_ds3.phone_number, order_kt3.Payment_Content, order_kt3.Source, order_kt3.Original_Price, order_kt3.Ex, order_kt3.Market, order_ds3.email\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt3\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds3\r\non order_kt3.Order_Code \u003d order_ds3.invoice_code\r\nwhere order_kt3.Payment_Content not in (\u0027Học thử\u0027,\u0027Đơn hoàn tiền\u0027,\u0027Hoàn tiền\u0027) and order_kt3.Code_Contract is null ) t4\r\n\r\nfull join\r\n\r\n(select t5.phone_number,\r\nmin(t5.accounting_date) as first_time_purchase_phone\r\nfrom (select\r\nif(order_ds4.accounting_date is null,order_ds4.created_at,order_ds4.accounting_date)  as accounting_date, order_kt4.Order_Code, order_ds4.phone_number\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt4\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds4\r\non order_kt4.Order_Code \u003d order_ds4.invoice_code\r\nwhere order_kt4.Payment_Content not in (\u0027Đơn hoàn tiền\u0027,\u0027Hoàn tiền\u0027,\u0027Học thử\u0027) and order_kt4.Code_Contract is null) t5\r\ngroup by t5.phone_number order by t5.phone_number) t6\r\n\r\non t4.phone_number \u003d t6.phone_number\r\n\r\nfull join\r\n  \r\n(select t55.email,\r\nmin(t55.accounting_date) as first_time_purchase_email\r\nfrom (select\r\nif(order_ds44.accounting_date is null,order_ds44.created_at,order_ds44.accounting_date)  as accounting_date, order_kt44.Order_Code, order_ds44.email\r\nfrom kynaforkids-server-production.accounting_kynaforkids.Order_Tutoring as order_kt44\r\njoin kynaforkids-server-production.kynaforkids.booking_order as order_ds44\r\non order_kt44.Order_Code \u003d order_ds44.invoice_code\r\nwhere order_kt44.Payment_Content not in (\u0027Đơn hoàn tiền\u0027,\u0027Hoàn tiền\u0027,\u0027Học thử\u0027) and order_kt44.Code_Contract is null) t55\r\ngroup by t55.email order by t55.email) t66\r\n\r\non t4.email \u003d t66.email\r\n\r\n  \r\ngroup by Order_Code, Phone_Number, month_kt, purchase_date, first_time_purchase_phone, Email, first_time_purchase_email, Payment_Content, Source);"
}, {
  "table_name": "test_duration_first_order",
  "ddl": "CREATE VIEW `kynaforkids-server-production.accounting_kynaforkids.test_duration_first_order`\nAS WITH\r\n\r\ntable_1 as(\r\n    SELECT DATE(bo.accounting_date) as accounting_date, bo.student_id, bo.student_code, bo.invoice_code, bo.student_payment_id, bo.total, bo.total_lesson,bo.total_gift_lesson, bo.duration, bph.remain_lesson\r\n          ,bo.payment_content\r\n    FROM `kynaforkids-server-production.kynaforkids.booking_order_view` bo \r\n    LEFT JOIN `kynaforkids-server-production.kynaforkids.booking_payment_history` bph\r\n    ON bo.student_payment_id \u003d bph.id\r\n    WHERE\r\n    bo.payment_content \u003d 2 \r\n    AND bo.payment_status \u003d 1\r\n)\r\n,\r\n\r\ntable_2 AS\r\n(\r\n    SELECT\r\n     t1.student_payment_id\r\n     , min(t1.begin_at) as starting_date\r\n     , max(t1.begin_at) as ending_date\r\n    FROM\r\n      ( SELECT bst.booking_session_id, DATE(bs.begin_at) as begin_at, bst.student_id, bst.student_payment_id, bst.currency_exchange_rate, bst.revenue, bs.status_id, bs.cancel_config_id\r\n         FROM `kynaforkids-server-production.kynaforkids.booking_session_student` bst\r\n         LEFT JOIN `kynaforkids-server-production.kynaforkids.booking_session_view` bs\r\n         ON bst.booking_session_id \u003d bs.id\r\n         WHERE bs.status_id !\u003d 8 ) t1\r\n\r\n    GROUP BY student_payment_id\r\n)\r\n\r\nSELECT * FROM table_1 t1\r\nLEFT JOIN table_2 t2 ON t1.student_payment_id \u003d t2.student_payment_id;"
}]