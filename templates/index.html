<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Assistant Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .session-active { background-color: #374151 !important; border-left: 4px solid #3b82f6; }
        pre { margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <div class="w-72 bg-gray-900 text-gray-300 flex flex-col shadow-xl z-20">
        <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-800">
            <h1 class="font-bold text-white tracking-wide"><i class="fas fa-database mr-2 text-blue-500"></i>SQL Pro</h1>
            <div class="flex gap-2">
                <button onclick="createNewSession()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg transition shadow" title="Chat m·ªõi">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-500 text-white p-2 rounded-lg transition shadow" title="X√≥a to√†n b·ªô l·ªãch s·ª≠">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="px-4 py-2 bg-red-900/50 text-red-200 text-xs flex items-center justify-center transition-colors duration-300">
            <i class="fas fa-wifi mr-2"></i> <span>M·∫•t k·∫øt n·ªëi Server</span>
        </div>

        <div id="sessionList" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        <div class="p-4 border-t border-gray-700 text-xs text-center text-gray-500 bg-gray-800">
            PostgreSQL Storage
        </div>
    </div>

    <!-- MAIN CHAT -->
    <div class="flex-1 flex flex-col relative bg-white">
        <header class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-10">
            <div>
                <h2 id="chatTitle" class="font-bold text-gray-800 text-lg">üí¨ Chat m·ªõi</h2>
                <p class="text-xs text-gray-500">BigQuery SQL Generator</p>
            </div>
            <button onclick="reloadSchema()" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 px-3 py-1 rounded hover:bg-blue-50">
                <i class="fas fa-sync-alt"></i> Reload Data
            </button>
        </header>

        <div id="chatBox" class="flex-1 p-6 overflow-y-auto space-y-6 pb-24 scroll-smooth">
            <!-- Messages -->
        </div>

        <div class="p-4 bg-white border-t absolute bottom-0 w-full z-10">
            <div class="max-w-4xl mx-auto flex gap-2 relative">
                <input type="text" id="userInput" 
                    class="flex-1 border border-gray-300 rounded-xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm text-gray-700"
                    placeholder="V√≠ d·ª•: L·∫•y danh s√°ch h·ªçc vi√™n tr·∫°ng th√°i 'Completed'...">
                <button onclick="sendMessage()" 
                    class="absolute right-3 top-3 bottom-3 bg-blue-600 text-white px-6 rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isConnected = false;
        
        // --- C·∫§U H√åNH API URL ---
        function getApiUrl(endpoint) {
            const isLocalPreview = window.location.protocol === 'blob:' || window.location.protocol === 'file:';
            return isLocalPreview ? `http://127.0.0.1:5000${endpoint}` : endpoint;
        }

        // --- C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI UI ---
        function setConnectionStatus(online) {
            isConnected = online;
            const statusDiv = document.getElementById('connectionStatus');
            if (online) {
                statusDiv.className = "px-4 py-2 bg-green-900/50 text-green-200 text-xs flex items-center justify-center transition-colors duration-300";
                statusDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> <span>Server Online</span>';
                // ·∫®n sau 2 gi√¢y n·∫øu online
                setTimeout(() => { if(isConnected) statusDiv.style.display = 'none'; }, 2000);
            } else {
                statusDiv.style.display = 'flex';
                statusDiv.className = "px-4 py-2 bg-red-900/50 text-red-200 text-xs flex items-center justify-center transition-colors duration-300";
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> <span>M·∫•t k·∫øt n·ªëi Server</span>';
            }
        }

        // --- H√ÄM FETCH AN TO√ÄN ---
        async function safeFetch(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                setConnectionStatus(true);
                return await response.json();
            } catch (error) {
                console.warn("L·ªói k·∫øt n·ªëi API:", error);
                setConnectionStatus(false);
                return null;
            }
        }

        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        document.addEventListener("DOMContentLoaded", () => {
            loadSessions();
            createNewSession();
            
            // T·ª± ƒë·ªông ki·ªÉm tra k·∫øt n·ªëi m·ªói 10s
            setInterval(() => { if(!isConnected) loadSessions(true); }, 10000);
        });

        function createNewSession() {
            currentSessionId = uuid();
            document.getElementById('chatBox').innerHTML = `
                <div class="text-center mt-20 text-gray-400 animate-pulse">
                    <i class="fas fa-code text-6xl mb-4 text-blue-200"></i>
                    <p class="text-lg font-medium">S·∫µn s√†ng h·ªó tr·ª£!</p>
                </div>`;
            document.getElementById('chatTitle').innerText = "üí¨ Cu·ªôc tr√≤ chuy·ªán m·ªõi";
            loadSessions();
        }

        async function loadSessions(silent = false) {
            const data = await safeFetch(getApiUrl('/api/sessions'));
            
            if (!data) {
                if(!silent) document.getElementById('sessionList').innerHTML = '<div class="text-center text-xs text-red-400 mt-4">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</div>';
                return;
            }

            const list = document.getElementById('sessionList');
            list.innerHTML = '';
            
            if (data.length === 0) {
                list.innerHTML = '<div class="text-center text-xs text-gray-500 mt-4">Ch∆∞a c√≥ l·ªãch s·ª≠</div>';
                return;
            }

            data.forEach(s => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer hover:bg-gray-700 transition text-sm truncate flex items-center gap-2 ${s.id === currentSessionId ? 'session-active text-white font-medium' : ''}`;
                div.innerHTML = `<i class="far fa-comments opacity-60"></i>${s.title}`;
                div.onclick = () => openSession(s.id, s.title);
                list.appendChild(div);
            });
        }

        async function openSession(id, title) {
            currentSessionId = id;
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatBox').innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            loadSessions();
            
            const msgs = await safeFetch(getApiUrl(`/api/history/${id}`));
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            
            if (!msgs) {
                box.innerHTML = '<div class="text-center mt-20 text-red-400">L·ªói t·∫£i tin nh·∫Øn</div>';
                return;
            }

            if(msgs.length === 0) box.innerHTML = '<div class="text-center mt-20 text-gray-400">Chat tr·ªëng</div>';
            else msgs.forEach(m => appendMessage(m.role, m.content));
            box.scrollTop = box.scrollHeight;
        }

        async function clearHistory() {
            if(confirm("B·∫†N C√ì CH·∫ÆC KH√îNG?\nTo√†n b·ªô l·ªãch s·ª≠ chat s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!")) {
                const res = await safeFetch(getApiUrl('/api/clear_history'), {method: 'POST'});
                if (res) {
                    alert(res.message || "ƒê√£ x√≥a th√†nh c√¥ng");
                    createNewSession(); 
                    loadSessions();
                } else {
                    alert("L·ªói k·∫øt n·ªëi server khi x√≥a");
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const txt = input.value.trim();
            if (!txt || !currentSessionId) return;

            appendMessage('user', txt);
            input.value = '';
            const loadingId = appendMessage('bot', 'typing', true);

            const data = await safeFetch(getApiUrl('/api/chat'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ session_id: currentSessionId, message: txt })
            });

            document.getElementById(loadingId).remove();

            if (!data) {
                appendMessage('bot', `‚ö†Ô∏è L·ªói k·∫øt n·ªëi: Kh√¥ng th·ªÉ g·ªçi Server.\nH√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ ch·∫°y l·ªánh 'python app.py' v√† m·ªü file HTML n√†y b·∫±ng tr√¨nh duy·ªát (n·∫øu ch·∫°y local).`);
            } else if (data.error) {
                appendMessage('bot', `‚ö†Ô∏è L·ªói Server: ${data.error}`);
            } else {
                appendMessage('bot', data.response);
                loadSessions(true);
            }
        }

        function appendMessage(role, text, isLoading=false) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (isLoading) {
                div.innerHTML = `<div class="bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none text-gray-500 italic text-sm shadow-sm flex items-center gap-2">
                                    <i class="fas fa-circle-notch fa-spin text-blue-500"></i> ƒêang suy nghƒ©...
                                 </div>`;
            } else if (role === 'user') {
                div.innerHTML = `<div class="bg-blue-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[85%] shadow-md whitespace-pre-wrap">${text}</div>`;
            } else {
                const html = marked.parse(text);
                div.innerHTML = `<div class="bg-white border border-gray-200 text-gray-800 px-6 py-4 rounded-2xl rounded-tl-none max-w-[90%] shadow-sm prose prose-sm overflow-hidden">${html}</div>`;
            }
            box.appendChild(div);
            div.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            box.scrollTop = box.scrollHeight;
            return div.id = 'msg-' + Date.now();
        }

        async function reloadSchema() {
            if(confirm("Reload l·∫°i d·ªØ li·ªáu Schema?")) {
                const res = await safeFetch(getApiUrl('/api/reload'), {method: 'POST'});
                if (res) alert("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu!");
                else alert("L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t!");
            }
        }

        document.getElementById('userInput').addEventListener('keypress', e => {
            if(e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
